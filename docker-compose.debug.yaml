# Docker Compose for debugging services in containers
# Usage: docker-compose -f docker-compose.yaml -f docker-compose.debug.yaml up -d

services:
  # .NET Order Service with remote debugging
  order-service:
    build:
      context: .
      dockerfile: OrderService/Dockerfile.debug
    container_name: order-service
    ports:
      - "5011:5011"     # REST
      - "50011:50011"   # gRPC
      - "4011:2222"     # Debug port (host 4011 -> container 2222)
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5011;http://+:50011
      - ConnectionStrings__DefaultConnection=Host=order-db;Database=orders_db;Username=admin;Password=password123
      - GrpcSettings__PaymentServiceUrl=http://payment-service:50012
      - GrpcSettings__InventoryServiceUrl=http://inventory-service:50013
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - LOKI_URL=http://loki:3100
    depends_on:
      - order-db
      - otel-collector

  # Node.js Payment Service with remote debugging
  payment-service:
    build:
      context: .
      dockerfile: PaymentService/Dockerfile.debug
    container_name: payment-service
    ports:
      - "5012:5012"    # REST
      - "50012:50012"  # gRPC
      - "4012:9229"    # Debug port (host 4012 -> container 9229)
    environment:
      - NODE_ENV=development
      - PORT=50012
      - REST_PORT=5012
      - MONGO_URI=mongodb://admin:password123@payment-db:27017
      - MONGO_DB_NAME=payments_db
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SERVICE_NAME=PaymentService
      - LOKI_URL=http://loki:3100
    depends_on:
      - payment-db
      - otel-collector

  # .NET Identity Service with remote debugging
  identity-service:
    build:
      context: .
      dockerfile: IdentityService/Dockerfile.debug
    container_name: identity-service
    ports:
      - "5010:5010"   # HTTP
      - "4010:2222"   # Debug port (host 4010 -> container 2222)
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5010
      - Jwt__Key=ThisIsAVerySecretKeyForDevelopmentOnly123!
      - Jwt__Issuer=IdentityService
      - Jwt__Audience=MicroserviceApp
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - LOKI_URL=http://loki:3100

  # Go Inventory Service
  inventory-service:
    build:
      context: .
      dockerfile: InventoryService/Dockerfile.debug
    container_name: inventory-service
    environment:
      - DB_HOST=inventory-db
      - DB_USER=admin
      - DB_PASSWORD=password123
      - DB_NAME=inventory_db
      - DB_PORT=5432
      - GRPC_PORT=50013
      - REST_PORT=5013
      - SERVICE_NAME=InventoryService
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - LOKI_URL=http://loki:3100
    depends_on:
      - inventory-db
      - otel-collector
    ports:
      - "5013:5013"
      - "50013:50013"
      - "4013:4013" # Debug port (Delve)

  # Angular Back Office
  back-office:
    build:
      context: .
      dockerfile: back-office/Dockerfile
    container_name: back-office
    ports:
      - "5015:80"
    depends_on:
      - inventory-service
